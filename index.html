<canvas id="grafico" width="560" height="480" style="border: 2px solid #000000" tabindex="0"> </canvas>

<script>
  const canvasWidth = 560;
  const canvasHeight = 480;
  const pantalla = document.getElementById("grafico");
  const pincel = pantalla.getContext("2d");

  let xInicial = 0;
  let yInicial = 0;
  const cuadroWidth = 40;
  const cuadroHeight = 40;
  const cuadroAleatorioWidth = canvasWidth - cuadroWidth;
  const cuadroAleatorioHeight = canvasHeight - cuadroHeight;
  let intervalDerecha;
  let intervalIzquierda;
  let intervalArriba;
  let intervalAbajo;
  const cantidad = 4;
  const velocidad = 125;
  let direccionDerecha = true;
  let direccionIzquierda = false;
  let direccionArriba = false;
  let direccionAbajo = false;
  let agregarCuadroPorMovimiento = true;

  const xAleatorioInicial = calcularNumeroBase(cuadroWidth, cuadroAleatorioWidth, cuadroWidth);
  const yAleatorioInicial = calcularNumeroBase(cuadroHeight, cuadroAleatorioHeight, cuadroHeight);

  const cuadroAleatorio = { x: xAleatorioInicial, y: yAleatorioInicial };
  const serpiente = [];

  function culebraInicial() {
    serpiente.length = 0;
    for (let i = 0; i < cantidad; i++) {
      serpiente.push({ x: xInicial + cuadroWidth * i, y: yInicial });
    }
  }

  function calcularNumeroBase(min, max, base) {
    let num = Math.floor(Math.random() * (max + 1 - min) + min);
    while (num % base !== 0 && num > 0) {
      num = Math.floor(Math.random() * (max + 1 - min) + min);
    }
    return num;
  }

  function comidaEnSerpiente(){
    for (let coordenadaCuadro of serpiente){
      if(coordenadaCuadro.x === cuadroAleatorio.x && coordenadaCuadro.y === cuadroAleatorio.y ){
        //console.log("Comida en serpiente")
        return true;
        break;
      }
    }
    return false;

  }

  function moverCuadroAleatorio() {
    cuadroAleatorio.x = calcularNumeroBase(0, cuadroAleatorioWidth, cuadroWidth);
    cuadroAleatorio.y = calcularNumeroBase(0, cuadroAleatorioHeight, cuadroHeight);

    while(comidaEnSerpiente() === true){
      cuadroAleatorio.x = calcularNumeroBase(0, cuadroAleatorioWidth, cuadroWidth);
      cuadroAleatorio.y = calcularNumeroBase(0, cuadroAleatorioHeight, cuadroHeight);
    }

    pintarCuadroAleatorio();
  }

  function chocarConSerpiente(){
    const tamano = serpiente.length;
    const cabeza = {x: serpiente[tamano-1].x, y: serpiente[tamano-1].y};
    //console.log(cabeza);

    for(let i = 0; i <= tamano-2; i++){
      //console.log(serpiente[i]);
      if (cabeza.x === serpiente[i].x && cabeza.y === serpiente[i].y){
        //console.log("CHOCO CON LA SERPIENTE");
        reiniciar();
        break;
      }
    }
  }

  function pintarCuadroAleatorio() {
    pincel.fillStyle = "crimson";
    pincel.strokeStyle = "black";

    pincel.fillRect(cuadroAleatorio.x, cuadroAleatorio.y, cuadroWidth, cuadroHeight);
    pincel.strokeRect(cuadroAleatorio.x, cuadroAleatorio.y, cuadroWidth, cuadroHeight);
  }

  async function agregarCuadroAtrapado(tecla,segundos) {
    //console.log(velocidad - segundos)
    const cantidadActualAtr = serpiente.length;
    let xAlt = cuadroAleatorio.x;
    let yAlt = cuadroAleatorio.y;

    switch (tecla) {
      case "ArrowRight":
        if (direccionDerecha) {
          const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad - segundos));
          serpiente.push({ x: xAlt + cuadroWidth, y: yAlt });
          chocarConSerpiente();
          pintarSerpiente("ArrowRight");
          moverCuadroAleatorio();
          if (serpiente[cantidadActualAtr].x > canvasWidth - cuadroWidth) {
            reiniciar();
          } else {
            moverSerpiente({ key: "ArrowRight" });
          }
          limpiarMovimientoDerecha();
        }
        break;
      case "ArrowLeft":
        if (direccionIzquierda) {
          const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad - segundos));
          serpiente.push({ x: xAlt - cuadroWidth, y: yAlt });
          chocarConSerpiente();
          pintarSerpiente("ArrowLeft");
          moverCuadroAleatorio();
          if (serpiente[cantidadActualAtr].x < 0) {
            reiniciar();
          } else {
            moverSerpiente({ key: "ArrowLeft" });
          }
          limpiarMovimientoIzquierda();
        }
        break;
      case "ArrowUp":
        if (direccionArriba) {
          const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad - segundos));
          serpiente.push({ x: xAlt, y: yAlt - cuadroHeight });
          chocarConSerpiente();
          pintarSerpiente("ArrowUp");
          moverCuadroAleatorio();
          if (serpiente[cantidadActualAtr].y < 0) {
            reiniciar();
          } else {
            moverSerpiente({ key: "ArrowUp" });
          }
          limpiarMovimientoArriba();
        }
        break;
      case "ArrowDown":
        if (direccionAbajo) {
          const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad - segundos));
          serpiente.push({ x: xAlt, y: yAlt + cuadroHeight });
          chocarConSerpiente();
          pintarSerpiente("ArrowDown");
          moverCuadroAleatorio();
          if (serpiente[cantidadActualAtr].y > canvasHeight - cuadroHeight) {
            reiniciar();
          } else {
            moverSerpiente({ key: "ArrowDown" });
          }
          limpiarMovimientoAbajo();
        }
        break;
    }
  }

  async function mantenerMovimientoDespuesDeAtraparComida(direccion){
    limpiarIntervalos();
    //Este Promise con  SetTimeout es para esperar unos segundos,
    //si no se presiona una tecla al atrapar la comida se activa
    //el movimiento en la misma direccion que viene.
    const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad));
    //console.log(agregarCuadroPorMovimiento);
    switch (direccion) {
      case "ArrowRight":
        if (agregarCuadroPorMovimiento) {
          //console.log("DERECHA EN PINTAR SERPIENTE");
          direccionDerecha = true;
          agregarCuadroAtrapado(direccion,velocidad);
          //intervalDerecha = setInterval(moverSerpienteDerecha, velocidad);
          //moverSerpienteDerecha();
          //limpiarMovimientoDerecha();
        }
        break;

      case "ArrowLeft":
        if (agregarCuadroPorMovimiento) {
          //console.log("IZQUIERDA EN PINTAR SERPIENTE");
          direccionIzquierda = true;
          agregarCuadroAtrapado(direccion,velocidad);
          //moverSerpienteIzquierda();
          //limpiarMovimientoIzquierda();
        }
        break;

      case "ArrowUp":
        if (agregarCuadroPorMovimiento) {
          //console.log("ARRIBA EN PINTAR SERPIENTE");
          direccionArriba = true;
          agregarCuadroAtrapado(direccion,velocidad);
          //moverSerpienteArriba();
          //limpiarMovimientoArriba();
        }
        break;

      case "ArrowDown":
        if (agregarCuadroPorMovimiento) {
          //console.log("ABAJO EN PINTAR SERPIENTE");
          direccionAbajo = true;
          agregarCuadroAtrapado(direccion,velocidad);
          //moverSerpienteAbajo();
          //limpiarMovimientoAbajo();
        }
        break;
    }
  }

  function pintarSerpiente(direccion) {
    //console.log(serpiente.length);
    limpiarPantalla();

    pincel.fillStyle = "deepskyblue";
    pincel.strokeStyle = "black";

    for (const posicion of serpiente) {
      pincel.fillRect(posicion.x, posicion.y, cuadroWidth, cuadroHeight);
      pincel.strokeRect(posicion.x, posicion.y, cuadroWidth, cuadroHeight);
    }

    const cantidadActual = serpiente.length;
    //Verificar si la serpiente esta en la comida
    if (serpiente[cantidadActual - 1].x === cuadroAleatorio.x && serpiente[cantidadActual - 1].y === cuadroAleatorio.y) {
      //console.log("ATRAPADO");
      mantenerMovimientoDespuesDeAtraparComida(direccion);
    }
  }

  function limpiarPantalla() {
    pincel.clearRect(0, 0, canvasWidth, canvasHeight);
    pintarCuadroAleatorio();
  }

  function moverSerpienteDerecha() {
    const cantidadActualDer = serpiente.length;
    let xActual = serpiente[cantidadActualDer - 1].x;
    let yActual = serpiente[cantidadActualDer - 1].y;
    //Asignando la coordenada a donde va el ultimo cuadro
    serpiente[cantidadActualDer - 1] = { x: xActual + cuadroWidth, y: yActual };
    //Asignando a los primeros cuadros la posicion del siguiente
    for (let i = 0; i < cantidadActualDer - 2; i++) {
      serpiente[i] = serpiente[i + 1];
    }
    //Asignando al penultimo cuadro la posicion del ultimo
    serpiente[cantidadActualDer - 2] = { x: xActual, y: yActual };
    //Si choca con el limite reiniciar el juego
    if (serpiente[cantidadActualDer - 1].x > canvasWidth - cuadroWidth) {
      reiniciar();
    }
    chocarConSerpiente();
    pintarSerpiente("ArrowRight");
  }

  function moverSerpienteIzquierda() {
    const cantidadActualIzq = Object.keys(serpiente).length;
    let xActual = serpiente[cantidadActualIzq - 1].x;
    let yActual = serpiente[cantidadActualIzq - 1].y;
    //Asignando la coordenada a donde va el ultimo cuadro
    serpiente[cantidadActualIzq - 1] = { x: xActual - cuadroWidth, y: yActual };
    //Asignando a los primeros cuadros la posicion del siguiente
    for (let i = 0; i < cantidadActualIzq - 2; i++) {
      serpiente[i] = serpiente[i + 1];
    }
    //Asignando al penultimo cuadro la posicion del ultimo
    serpiente[cantidadActualIzq - 2] = { x: xActual, y: yActual };
    //Si choca con el limite reiniciar el juego
    if (serpiente[cantidadActualIzq - 1].x < 0) {
      reiniciar();
    }
    chocarConSerpiente();
    pintarSerpiente("ArrowLeft");
  }

  function moverSerpienteArriba() {
    const cantidadActualArr = Object.keys(serpiente).length;
    let xActual = serpiente[cantidadActualArr - 1].x;
    let yActual = serpiente[cantidadActualArr - 1].y;
    //Asignando coordenadas del ultimo cuadro
    serpiente[cantidadActualArr - 1] = { x: xActual, y: yActual - cuadroHeight };
    //Asignando a los primeros cuadros la posicion del siguiente
    for (let i = 0; i < cantidadActualArr - 2; i++) {
      serpiente[i] = serpiente[i + 1];
    }
    //Asignando al penultimo cuadro la posicion del ultimo
    serpiente[cantidadActualArr - 2] = { x: xActual, y: yActual };
    //Si choca con el limite reiniciar el juego
    if (serpiente[cantidadActualArr - 1].y < 0) {
      reiniciar();
    }
    chocarConSerpiente();
    pintarSerpiente("ArrowUp");
  }

  function moverSerpienteAbajo() {
    const cantidadActualAba = Object.keys(serpiente).length;
    let xActual = serpiente[cantidadActualAba - 1].x;
    let yActual = serpiente[cantidadActualAba - 1].y;
    //Asignando coordenadas del ultimo cuadro
    serpiente[cantidadActualAba - 1] = { x: xActual, y: yActual + cuadroHeight };
    //Asignando a los primeros cuadros la posicion del siguiente
    for (let i = 0; i < cantidadActualAba - 2; i++) {
      serpiente[i] = serpiente[i + 1];
    }
    //Asignando al penultimo cuadro la posicion del ultimo
    serpiente[cantidadActualAba - 2] = { x: xActual, y: yActual };
    //Si choca con el limite reiniciar el juego
    if (serpiente[cantidadActualAba - 1].y > canvasHeight - cuadroHeight) {
      reiniciar();
    }
    chocarConSerpiente();
    pintarSerpiente("ArrowDown");
  }

  function limpiarIntervalos() {
    clearInterval(intervalDerecha);
    clearInterval(intervalIzquierda);
    clearInterval(intervalArriba);
    clearInterval(intervalAbajo);
  }

  function reiniciar() {
    limpiarPantalla();
    limpiarIntervalos();
    culebraInicial();
    pintarSerpiente("ArrowRight");
    moverCuadroAleatorio();
    direccionDerecha = true;
    direccionIzquierda = false;
    direccionArriba = false;
    direccionAbajo = false;
  }

  async function moverSerpiente(e) {
    const cantidadActual = serpiente.length;
    //console.log(e.key)
    if (serpiente[cantidadActual - 1].x === cuadroAleatorio.x && serpiente[cantidadActual - 1].y === cuadroAleatorio.y) {
      //Para desactivar el switch que se ejecuta despues del setTimeout
      //en la funcion pintarSerpiente porque ya no hace falta,
      //el movimiento se va a activar con la pulsacion del teclado.
      agregarCuadroPorMovimiento = false;
      agregarCuadroAtrapado(e.key,velocidad * 0.25);
    } else {
      switch (e.key) {
        case "ArrowRight":
          //console.log("TECLA DERECHA");
          if (direccionDerecha) {
            limpiarIntervalos();
            intervalDerecha = setInterval(moverSerpienteDerecha, velocidad);
            const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad));
            limpiarMovimientoDerecha();
            agregarCuadroPorMovimiento = true;
          }
          break;

        case "ArrowLeft":
          //console.log("TECLA IZQUIERDA");
          if (direccionIzquierda) {
            limpiarIntervalos();
            intervalIzquierda = setInterval(moverSerpienteIzquierda, velocidad);
            const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad));
            limpiarMovimientoIzquierda();
            agregarCuadroPorMovimiento = true;
          }
          break;

        case "ArrowUp":
          //console.log("TECLA ARRIBA");
          if (direccionArriba) {
            limpiarIntervalos();
            intervalArriba = setInterval(moverSerpienteArriba, velocidad);
            const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad));
            limpiarMovimientoArriba();
            agregarCuadroPorMovimiento = true;
          }
          break;

        case "ArrowDown":
          //console.log("TECLA ABAJO");
          if (direccionAbajo) {
            limpiarIntervalos();
            intervalAbajo = setInterval(moverSerpienteAbajo, velocidad);
            const respuestaTrue = await new Promise((resolve) => setTimeout(() => resolve(true), velocidad));
            limpiarMovimientoAbajo();
            agregarCuadroPorMovimiento = true;
          }
          break;
      }
    }
  }

  function limpiarMovimientoDerecha() {
    direccionDerecha = false;
    direccionIzquierda = false;
    direccionArriba = true;
    direccionAbajo = true;
  }

  function limpiarMovimientoIzquierda() {
    direccionDerecha = false;
    direccionIzquierda = false;
    direccionArriba = true;
    direccionAbajo = true;
  }

  function limpiarMovimientoArriba() {
    direccionDerecha = true;
    direccionIzquierda = true;
    direccionArriba = false;
    direccionAbajo = false;
  }

  function limpiarMovimientoAbajo() {
    direccionDerecha = true;
    direccionIzquierda = true;
    direccionArriba = false;
    direccionAbajo = false;
  }

  culebraInicial();
  pintarSerpiente("ArrowRight");
  pintarCuadroAleatorio();
  moverSerpiente({ key: "ArrowRight" });
  pantalla.focus();
  pantalla.onkeydown = moverSerpiente;
</script>
